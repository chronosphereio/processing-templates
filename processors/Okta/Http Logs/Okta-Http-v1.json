{"name":"Okta-Http-v1","config":{"Name":"lua","match":"*","code":"cb_filter=require('calyptia.pr')([====================[[{\"type\":\"replace\",\"opts\":{\"key\":\"log\",\"regex\":\"alternateId\\\\\\\":\\\\s(?<alt_id>[^\\\\\\\"\\\\,]+),\",\"matchCase\":false,\"replacement\":\"alternateId\\\": \\\"%1\\\",\",\"regexEngine\":\"pcre2\"},\"comment\":\"\",\"id\":\"8ad83807-6bdd-4134-bee0-86c776c8bcf0\",\"active\":true},{\"type\":\"replace\",\"opts\":{\"key\":\"log\",\"regex\":\"\\\\\\\"id\\\\\\\":\\\\\\\"(?<id>[^\\\\\\\"\\\\}]+)\\\\}\",\"matchCase\":false,\"replacement\":\"\\\"actor\\\": {\\\"id\\\": \\\"%1\\\"}\",\"regexEngine\":\"pcre2\"},\"comment\":\"\",\"id\":\"493341d9-8e3f-4a37-9aaa-96d749a6efe5\",\"active\":true},{\"type\":\"json_decode\",\"opts\":{\"src\":\"log\",\"dst\":\"decoded_json\"},\"comment\":\"\",\"id\":\"49f830ea-c477-4847-8577-145d159fdfea\",\"active\":true},{\"type\":\"delete\",\"opts\":{\"key\":\"log\"},\"comment\":\"remove original log field\",\"id\":\"30383ed5-f1e8-4a84-ab50-f6bdc9ef9668\",\"active\":true},{\"type\":\"flatten\",\"opts\":{\"key\":\"decoded_json\",\"regex\":\"^.+$\",\"keyReplacement\":\"%1\",\"keepOrig\":false},\"comment\":\"\",\"id\":\"489947fa-488c-4532-ac1a-d762bd43cb69\",\"active\":true},{\"type\":\"delete\",\"opts\":{\"key\":\"$value.debugContext\"},\"comment\":\"remove debugContext data\",\"id\":\"80f0701d-004c-4fa5-99f8-00c78a673f98\",\"active\":true},{\"type\":\"delete\",\"opts\":{\"key\":\"$value.client.geographicalContext\"},\"comment\":\"remove extra geo data\",\"id\":\"79b3623d-6b74-4a75-b540-89c886955238\",\"active\":true},{\"type\":\"flatten\",\"opts\":{\"key\":\"value\",\"regex\":\"^.+$\",\"keyReplacement\":\"%1\",\"keepOrig\":false},\"comment\":\"\",\"id\":\"214fd138-8d31-4ab4-9299-ea9b7934d207\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"-- Define a function that checks if a value is empty, \\\"\\\", n/a, or null\\nlocal function is_empty(v)\\n  return v == nil or v == \\\"\\\" or v == \\\"n/a\\\" or v == \\\"null\\\" \\nend\\n\\n-- Define a function that recursively removes empty keys from a subrecord\\nlocal function remove_empty_keys(subrecord)\\n  for k, v in pairs(subrecord) do\\n    -- Check if the value is empty using the 'is_empty' function\\n    if is_empty(v) then\\n      -- If the value is empty, delete the key\\n      subrecord[k] = nil\\n    elseif type(v) == 'table' then\\n      -- If the value is a table, recursively call the 'remove_empty_keys' function\\n      remove_empty_keys(v)\\n    end\\n  end\\nend\\n\\nreturn function(tag, ts, record)\\n  -- Check if the record has a 'scopeLog' field\\n  if record['client'] ~= nil then\\n    -- Call the 'remove_empty_keys' function on the 'scopeLog' subrecord\\n    remove_empty_keys(record['client'])\\n  end\\n  return 1, ts, record\\nend\"},\"comment\":\"check through keys, sub keys, and sub sub keys for empty or null or 'null' values and remove the key\",\"id\":\"2f1b8287-91eb-42d2-ad8a-8d27f7ec7242\",\"active\":true}]]====================])","call":"cb_filter"},"input":"{\"timestamp\": \"2024-08-12T15:59:02.015968Z\",\"log.source\": \"Okta\",\"value\": {\"target\": [{\"displayName\": \"David Manuso\",\"type\": \"User\",\"alternateId\": manuso_d@company.com,\"id\": \"00ufh1oixgcELs2qZ1d7\"},{\"displayName\": \"Access Token\",\"type\": \"access_token\",\"id\": \"AT.0ERuGJ0eDX-TaooUoxhK7g5d1PI7QLsYyfO1cDStG9s\",\"detailEntry\": {\"hash\": \"nKEUf9-lmRz867fxAzrBOQ\",\"subject\": \"00ufh1oiijXyLs2qZ1d7\",\"expires\": \"2024-08-12T16:58:01.000Z\"}}],\"version\": \"0\",\"transaction\": {\"type\": \"WEB\",\"detail\": {},\"id\": \"21f81277869gkl948bccfd8417f3fc3\"},\"debugContext\": {\"debugData\": {\"grantedScopes\": \"openid\",\"requestedScopes\": \"\",\"dtHash\": \"040e9d20c89b839e2fcfjfieos67899f00f2118c02ca72e6dc0d7fef5d1f6e3a\",\"requestUri\": \"/oauth2/v1/token\",\"redirectUri\": \"https://company-employee-dev-admin.oktapreview.com/admin/sso/callback\",\"requestId\": \"21f8127d23a4afa904hggfd8417f3fc3\",\"authCode\": \"dir-0IC4ngp-_1vvhgyfZg\",\"responseTime\": \"256\",\"grantType\": \"authorization_code\",\"url\": \"/oauth2/v1/token?\",\"clientAuthType\": \"none\",\"threatSuspected\": \"false\"}},\"request\": {\"ipChain\": [{\"version\": \"V4\",\"ip\": \"52.13.31.29\",\"geographicalContext\": {\"country\": \"United States\",\"city\": \"Boardman\",\"geolocation\": {\"lon\": -119.7257,\"lat\": 45.8234},\"postalCode\": \"97818\",\"state\": \"Oregon\"}}]},\"outcome\": {\"result\": \"SUCCESS\"},\"securityContext\": {\"domain\": \"amazonaws.com\",\"isProxy\": false,\"isp\": \"amazon.com inc\",\"asNumber\": 84032,\"asOrg\": \"amazon technologies inc.\"},\"authenticationContext\": {\"externalSessionId\": \"idxd6_DIE8CRCuu-94hfl8-yQ\",\"rootSessionId\": \"idxd6_DIE8CRCuu-94hfl8-yQ\",\"authenticationStep\": 0},\"eventType\": \"app.oauth2.token.grant.access_token\",\"published\": \"2024-08-12T15:58:01.104Z\",\"legacyEventType\": \"app.oauth2.token.grant.access_token_success\",\"actor\": {\"displayName\": \"Okta Admin Console\",\"type\": \"PublicClientApp\",\"alternateId\": \"0oa6lhf986hywkCTh1d7\",\"id\": \"okta.ac8936ed-07d4-5f25-gh89-368a1261a405\"},\"displayMessage\": \"OIDC access token is granted\",\"uuid\": \"a89d30ce-58c3-11ef-93hd-673bd2392927\",\"client\": {\"ipAddress\": \"52.13.31.63\",\"userAgent\": {\"browser\": \"UNKNOWN\",\"os\": \"Unknown\",\"rawUserAgent\": \"Okta-Integrations\"},\"zone\": \"null\",\"geographicalContext\": {\"country\": \"United States\",\"city\": \"Boardman\",\"geolocation\": {\"lon\": -119.7257,\"lat\": 45.8234},\"postalCode\": \"97818\",\"state\": \"Oregon\"},\"device\": \"Unknown\",\"id\": \"okta.8f9403h6-07d4-5f25-hj45-368a1261a405\"},\"severity\": \"INFO\"},\"log.origin\": \"Calyptia\",\"index\": 3}","isRawInput":true,"pipelineVersion":"24.9.1"}