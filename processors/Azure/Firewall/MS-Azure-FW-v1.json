{"name":"MS-Azure-FW-v1","config":{"Name":"lua","match":"*","code":"cb_filter=require('calyptia.pr')([====================[[{\"type\":\"parse\",\"opts\":{\"src\":\"$properties.msg\",\"dst\":\"properties\",\"regex\":\"(?<method>[^\\\\s]+)\\\\s+request\\\\sfrom\\\\s(?<src_ip>[^\\\\s\\\\:]+)\\\\:(?<src_port>[^\\\\s]+)\\\\sto\\\\s(?<dest_domain>[^\\\\s\\\\:]+)\\\\:(?<dest_port>[^\\\\s\\\\.]+)\\\\.(?<msg_detail>.+)\",\"regexEngine\":\"pcre2\"},\"comment\":\"extract method src dest and msg_detail\",\"id\":\"881a0b34-30c0-4b52-b0d2-af2b878030e8\",\"active\":true},{\"type\":\"parse\",\"opts\":{\"src\":\"$properties.msg_detail\",\"dst\":\"properties\",\"regex\":\"(\\\\sUrl:\\\\s(?<url>[^\\\\s]+)\\\\.\\\\s)?(\\\\s?Action:\\\\s(?<action>[^\\\\s\\\\.]+)\\\\.\\\\s(Policy:\\\\s(?<policy>[^\\\\.\\\\s]+)\\\\. Rule Collection Group: (?<rule_col_grp>[^\\\\s\\\\.]+)\\\\. Rule Collection: (?<rule_col>[^\\\\.\\\\s]+)\\\\. Rule: (?<rule>[^\\\\.\\\\,]+)(\\\\. Web Category: (?<web_category>[^\\\\s]+)|\\\\, HTTP)?)?(?<action_detail>.+)?)\",\"regexEngine\":\"pcre2\"},\"comment\":\"extract action policy and rules from msg_detail\",\"id\":\"a6762cc9-795d-4ecb-a7e0-52d45214ca40\",\"active\":true},{\"type\":\"delete\",\"opts\":{\"key\":\"$properties.msg\"},\"comment\":\"delete original msg field\",\"id\":\"d3a11ada-85b0-48fa-8e7f-7a3c1d828b49\",\"active\":true},{\"type\":\"delete\",\"opts\":{\"key\":\"$properties.msg_detail\"},\"comment\":\"delete msg_detail field\",\"id\":\"918b15b4-50e2-4776-b892-2f29c5ed991d\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"-- Define a function that checks if a value is empty, \\\"\\\", n/a, or null\\nlocal function is_empty(v)\\n    return v == nil or v == \\\"\\\" or v == \\\"n/a\\\" or v == \\\"null\\\" or v == false\\n  end\\n  \\n  -- Define a function that recursively removes empty keys from a subrecord\\n  local function remove_empty_keys(subrecord)\\n    for k, v in pairs(subrecord) do\\n      -- Check if the value is empty using the 'is_empty' function\\n      if is_empty(v) then\\n        -- If the value is empty, delete the key\\n        subrecord[k] = nil\\n      elseif type(v) == 'table' then\\n        -- If the value is a table, recursively call the 'remove_empty_keys' function\\n        remove_empty_keys(v)\\n      end\\n    end\\n  end\\n  \\n  return function(tag, ts, record)\\n    -- Check if the record has a 'scopeLog' field\\n    if record['properties'] ~= nil then\\n      -- Call the 'remove_empty_keys' function on the 'scopeLog' subrecord\\n      remove_empty_keys(record['properties'])\\n    end\\n    return 1, ts, record\\n  end\"},\"comment\":\"delete empty or false fields from the extracted msg field\",\"id\":\"1c2bc856-1db7-44d1-9307-9922a8b06afe\",\"active\":true}]]====================])","call":"cb_filter"},"input":"{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTPS request from 10.0.2.4:56029 to md-qp4jv5snxgk5.z13.blob.storage.azure.net:443. Action: Deny. No rule matched. Proceeding with default action\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-08T20:40:23.2140990Z\"}\n{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTPS request from 10.0.0.1:49553 to guestconfiguration.azure.com:443. Action: Allow. Policy: azfwpolicy-nbfw-prd-weeu-01. Rule Collection Group: DefaultApplicationRuleCollectionGroup. Rule Collection: enablement-genericwebcategory-prd-allow-200. Rule: Allowed Business-Use Webcategories. Web Category: ComputersAndTechnology\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-08T20:40:34.3470680Z\"}\n{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTP  request from 10.0.0.1:50776 to ocsp.msocsp.com:80. Url: ocsp.msocsp.com/MFQ=. Action: Allow. Policy: azfwpolicy-nbfw-prd-weeu-01. Rule Collection Group: DefaultApplicationRuleCollectionGroup. Rule Collection: generic-allow-500. Rule: Azure-to-AllowedServices, HTTP\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-08T20:40:39.3635100Z\"}\n{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTPS request from 10.0.0.1:59060 to instance01.westeurope.datafactory.azure.net:443. Action: Deny. Failed to resolve address adf-rt-prd-weeu-01.westeurope.datafactory.azure.net:443: lookup adf-rt-prd-weeu-01.westeurope.datafactory.azure.net on 10.0.0.53:53: no such host\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-08T20:40:44.3716770Z\"}\n{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTPS request from 10.0.0.1:6065. Action: Deny. Reason: SNI TLS extension was missing.\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-08T20:40:49.3912780Z\"}\n{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTPS request from 10.0.2.4:59051 to www.google.com:443. Action: Allow. Rule Collection: App-Coll01. Rule: Allow-Google\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-20T21:20:12.8979360Z\"}\n{\"category\":\"AzureFirewallApplicationRule\",\"operationName\":\"AzureFirewallApplicationRuleLog\",\"properties\":{\"msg\":\"HTTP  request from 10.0.2.4:60301 to au.download.windowsupdate.com:80. Url: au.download.windowsupdate.com/d/msdownload/update/software/updt/2022/04/windows10.0-kb5013890-x64-ndp48_f6451ab37c049183e0226d836b0aae8097b70472.cab. Action: Deny. No rule matched. Proceeding with default action\"},\"resourceId\":\"/SUBSCRIPTIONS/23103928-B2CF-472A-8CDB-0146E2849129/RESOURCEGROUPS/TEST-FW-RG/PROVIDERS/MICROSOFT.NETWORK/AZUREFIREWALLS/TEST-FW01\",\"time\":\"2022-06-20T21:20:12.8979360Z\"}","isRawInput":false,"pipelineVersion":"24.7.4"}