{"name":"MS-Windows-Eventlog-v2","config":{"Name":"lua","match":"*","code":"cb_filter=require('calyptia.pr')([====================[[{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    -- Define a table with the critical EventIDs\\n    local critical_event_ids = {4608, 4609, 4610, 4611, 4612, 4614, 4615, 4616, 4622, 4624, 4625, 4634, 4646, 4647, 4648, 4650, 4651, 4652, 4653, 4654, 4655, 4656, 4657, 4658, 4659, 4660, 4661, 4662, 4663, 4664, 4665, 4666, 4667, 4668, 4670, 4671, 4672, 4673, 4674, 4688, 4689, 4690, 4691, 4694, 4695, 4696, 4697, 4698, 4699, 4700, 4701, 4702, 4704, 4705, 4707, 4709, 4710, 4711, 4712, 4717, 4718, 4720, 4722, 4723, 4725, 4726, 4728, 4729, 4730, 4731, 4732, 4733, 4734, 4738, 4740, 4741, 4742, 4743, 4744, 4745, 4746, 4747, 4748, 4749, 4750, 4751, 4752, 4753, 4756, 4757, 4758, 4759, 4760, 4761, 4762, 4767, 4768, 4769, 4770, 4771, 4772, 4774, 4775, 4776, 4777, 4778, 4779, 4781, 4782, 4783, 4784, 4785, 4786, 4787, 4788, 4789, 4790, 4793, 4800, 4801, 4802, 4803, 4864, 4869, 4871, 4872, 4873, 4874, 4875, 4876, 4877, 4878, 4879, 4880, 4881, 4883, 4884, 4886, 4887, 4888, 4889, 4891, 4893, 4894, 4895, 4898, 4902, 4904, 4905, 4909, 4910, 4928, 4929, 4930, 4931, 4932, 4933, 4934, 4935, 4936, 4937, 4944, 4945, 4946, 4947, 4948, 4949, 4950, 4951, 4952, 4953, 4954, 4956, 4957, 4958, 4979, 4980, 4981, 4982, 4985, 5024, 5025, 5031, 5032, 5033, 5034, 5039, 5040, 5041, 5042, 5043, 5044, 5045, 5046, 5047, 5048, 5050, 5051, 5056, 5057, 5058, 5059, 5060, 5061, 5062, 5063, 5064, 5065, 5066, 5067, 5068, 5069, 5070, 5125, 5126, 5127, 5136, 5137, 5138, 5139, 5140, 5141, 5152, 5153, 5154, 5155, 5156, 5157, 5158, 5159, 5378, 5440, 5441, 5442, 5443, 5444, 5446, 5447, 5448, 5449, 5450, 5451, 5452, 5456, 5457, 5458, 5459, 5460, 5461, 5462, 5463, 5464, 5465, 5466, 5467, 5468, 5471, 5472, 5473, 5474, 5477, 5479, 5632, 5633, 5712, 5888, 5889, 5890, 6008, 6144, 6272, 24577, 24578, 24579, 24580, 24581, 24582, 24583, 24584, 24588, 24595, 24621, 5049, 5478, 561, 563, 625, 613, 614, 615, 616}\\n    -- Check if the EventID is in the critical_event_ids table\\n    if critical_event_ids[record['EventID']] ~= nil then\\n        -- Set the value of criticality to \\\"Low\\\"\\n        record['criticality'] = \\\"Low\\\"\\n    else\\n        -- Set the value of criticality to \\\"Medium/High\\\"\\n        record['criticality'] = \\\"Medium/High\\\"\\n    end\\n    return 1, ts, record\\nend\"},\"comment\":\"create a new field called \\\"criticality\\\", check if the EventID is one of these values:\\n\\n4608, 4609, 4610, 4611, 4612, 4614,\\n\\n\\nif so, set the value of criticality to \\\"Low\\\", otherwise set the value to \\\"Medium/High\\\"\",\"id\":\"a575f2e3-5347-4c1e-b13e-d0a11543251d\",\"active\":false},{\"type\":\"block_records\",\"opts\":{\"key\":\"criticality\",\"regex\":\"Low\",\"matchCase\":false,\"regexEngine\":\"pcre2\"},\"comment\":\"block events that microsoft says are low criticality\",\"id\":\"ea152e83-c712-4094-bd00-2cf4d184eac7\",\"active\":false},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    -- check if the record has a Message field\\n    if record['Message'] ~= nil then\\n        -- Prepend the string \\\"EventDetail\\\":\\\" to the beginning of the Message field\\n        record['Message'] = '{\\\"EventDetail\\\":\\\"' .. record['Message']\\n\\n        -- Replace specific patterns involving carriage return and newlines\\n        record['Message'] = record['Message']:gsub('\\\\r\\\\n\\\\r\\\\n([%w%s]+):\\\\r\\\\n\\\\t', '\\\"},\\\"%1\\\":{\\\"')  -- Replace \\\\r\\\\n and a tab sequence\\n        record['Message'] = record['Message']:gsub('\\\\r\\\\n\\\\r\\\\n([%w%s]+):\\\\t\\\\t\\\\t', '\\\"},\\\"%1\\\"::\\\"')  -- Replace \\\\r\\\\n and a tab sequence\\n        record['Message'] = record['Message']:gsub('\\\\r\\\\n\\\\t', '\\\",\\\"')   -- Replace \\\\r\\\\n and a tab with `\\\",\\\"`\\n        record['Message'] = record['Message']:gsub('%.\\\\r\\\\n\\\\r\\\\n', '\\\",\\\"')  -- Replace double \\\\r\\\\n with `\\\"}` to close a JSON structure\\n        record['Message'] = record['Message']:gsub('\\\\r\\\\n\\\\r\\\\n', '\\\"},\\\"FieldDescriptions\\\":[\\\"')  -- Replace double \\\\r\\\\n with `\\\"}` to close a JSON structure\\n\\n        -- Replace tab patterns\\n        record['Message'] = record['Message']:gsub(':\\\\t\\\\t\\\\t', '\\\":\\\"')  -- Replace triple tab sequence\\n        record['Message'] = record['Message']:gsub(':\\\\t\\\\t', '\\\":\\\"')    -- Replace double tab sequence\\n        record['Message'] = record['Message']:gsub(':\\\\t', '\\\":\\\"')      -- Replace single tab sequence\\n\\n        -- Replace spaces in key names only (i.e., before `\\\":\\\"`)\\n        record['Message'] = record['Message']:gsub('\\\\\\\"([%w%s]+)\\\\\\\":', function(key)\\n            -- Replace spaces in the key with underscores\\n            return '\\\"' .. key:gsub('%s', '_') .. '\\\":'\\n        end)\\n\\n        -- Fix missing quotes, commas, and other broken patterns\\n        record['Message'] = record['Message']:gsub('}([%w]+):', '},\\\"%1\\\":')  -- Add quotes and commas for broken patterns\\n        record['Message'] = record['Message']:gsub('([%w]+):', '\\\"%1\\\":')    -- Ensure all keys are quoted\\n        record['Message'] = record['Message']:gsub('::\\\"([%w]+)\\\"},', ':\\\"%1\\\",')    -- fix one sided arrays\\n        record['Message'] = record['Message']:gsub('\\\"\\\"C\\\"', '\\\"C')    -- fix malformed file paths\\n        record['Message'] = record['Message']:gsub('\\\\\\\\', '/')    -- change all double backslashes to forward slashes\\n\\n        -- Ensure the message ends correctly if it's being treated like JSON\\n        if not record['Message']:match('}$') then\\n            record['Message'] = record['Message'] .. '\\\"]'\\n        end\\n\\n        -- Wrap everything inside the outer JSON object {\\\"Event\\\": ...}\\n        record['Message'] = '{\\\"Event\\\":' .. record['Message'] .. '}'\\n    end\\n    return 1, ts, record\\nend\\n\"},\"comment\":\"convert message field to json string\",\"id\":\"5dacf81b-79dd-405f-a608-862676c5564a\",\"active\":true},{\"type\":\"json_decode\",\"opts\":{\"src\":\"Message\",\"dst\":\"decoded_json\"},\"comment\":\"\",\"id\":\"032f26a5-2555-4337-8f4d-3f389f419125\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"-- Define a function that checks if a value is empty, \\\"\\\", n/a, or null\\nlocal function is_empty(v)\\n    return v == nil or v == \\\"\\\" or v == \\\"n/a\\\" or v == \\\"null\\\" or v == \\\"-\\\"\\n  end\\n  \\n  -- Define a function that recursively removes empty keys from a subrecord\\n  local function remove_empty_keys(subrecord)\\n    for k, v in pairs(subrecord) do\\n      -- Check if the value is empty using the 'is_empty' function\\n      if is_empty(v) then\\n        -- If the value is empty, delete the key\\n        subrecord[k] = nil\\n      elseif type(v) == 'table' then\\n        -- If the value is a table, recursively call the 'remove_empty_keys' function\\n        remove_empty_keys(v)\\n      end\\n    end\\n  end\\n  \\n  return function(tag, ts, record)\\n    -- Check if the record has a 'scopeLog' field\\n    if record['decoded_json'] ~= nil then\\n      -- Call the 'remove_empty_keys' function on the 'scopeLog' subrecord\\n      remove_empty_keys(record['decoded_json'])\\n    end\\n    return 1, ts, record\\n  end\"},\"comment\":\"remove keys with empty values\",\"id\":\"3916b49a-c75b-411f-86c2-802160329a8d\",\"active\":true},{\"type\":\"flatten\",\"opts\":{\"key\":\"decoded_json\",\"regex\":\"^.+$\",\"keyReplacement\":\"%1\",\"keepOrig\":false},\"comment\":\"\",\"id\":\"ef9baac7-befc-4b9e-b496-98023d4c3218\",\"active\":true},{\"type\":\"block_keys\",\"opts\":{\"regex\":\"Message|FieldDescriptions|StringInserts\",\"matchCase\":false,\"regexEngine\":\"pcre2\",\"nestedPath\":\"\"},\"comment\":\"remove Message, StringInserts, FieldDescriptions\",\"id\":\"66921445-6daf-4f5c-9287-7d7bb7ce35aa\",\"active\":true},{\"type\":\"custom_script\",\"opts\":{\"script\":\"return function(tag, ts, record)\\n    for k, v in pairs(record) do\\n        -- check if the value is empty\\n        if v == '' then\\n            -- delete the key\\n            record[k] = nil\\n        end\\n    end\\n    return 1, ts, record\\nend\"},\"comment\":\"remove empty keys\",\"id\":\"7860cd6b-bfce-47ba-ba2a-c25fff237e77\",\"active\":true}]]====================])","call":"cb_filter"},"input":"{\"date\":1723064658.95523,\"ProviderName\":\"Microsoft-Windows-Security-Auditing\",\"ProviderGuid\":\"{54849625-5478-4994-A5BA-3E3B0328C30D}\",\"Qualifiers\":\"\",\"EventID\":4625,\"Version\":0,\"Level\":0,\"Task\":12544,\"Opcode\":0,\"Keywords\":\"0x8010000000000000\",\"TimeCreated\":\"2024-07-25 12:35:39 +0000\",\"EventRecordID\":5213393,\"ActivityID\":\"{52090A2B-42D0-0000-C35D-9EE44ED3DA01}\",\"RelatedActivityID\":\"\",\"ProcessID\":628,\"ThreadID\":5004,\"Channel\":\"Security\",\"Computer\":\"enrique-secondw.calyptiatest.corp\",\"UserID\":\"\",\"Message\":\"An account failed to log on.\\r\\n\\r\\nSubject:\\r\\n\\tSecurity ID:\\t\\tS-1-0-0\\r\\n\\tAccount Name:\\t\\t-\\r\\n\\tAccount Domain:\\t\\t-\\r\\n\\tLogon ID:\\t\\t0x0\\r\\n\\r\\nLogon Type:\\t\\t\\t3\\r\\n\\r\\nAccount For Which Logon Failed:\\r\\n\\tSecurity ID:\\t\\tS-1-0-0\\r\\n\\tAccount Name:\\t\\tFeadmin\\r\\n\\tAccount Domain:\\t\\t-\\r\\n\\r\\nFailure Information:\\r\\n\\tFailure Reason:\\t\\tUnknown user name or bad password.\\r\\n\\tStatus:\\t\\t\\t0xC000006D\\r\\n\\tSub Status:\\t\\t0xC0000064\\r\\n\\r\\nProcess Information:\\r\\n\\tCaller Process ID:\\t0x0\\r\\n\\tCaller Process Name:\\t-\\r\\n\\r\\nNetwork Information:\\r\\n\\tWorkstation Name:\\tHAWKING\\r\\n\\tSource Network Address:\\t193.3.19.205\\r\\n\\tSource Port:\\t\\t0\\r\\n\\r\\nDetailed Authentication Information:\\r\\n\\tLogon Process:\\t\\tNtLmSsp \\r\\n\\tAuthentication Package:\\tNTLM\\r\\n\\tTransited Services:\\t-\\r\\n\\tPackage Name (NTLM only):\\t-\\r\\n\\tKey Length:\\t\\t0\\r\\n\\r\\nThis event is generated when a logon request fails. It is generated on the computer where access was attempted.\\r\\n\\r\\nThe Subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\\r\\n\\r\\nThe Logon Type field indicates the kind of logon that was requested. The most common types are 2 (interactive) and 3 (network).\\r\\n\\r\\nThe Process Information fields indicate which account and process on the system requested the logon.\\r\\n\\r\\nThe Network Information fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\\r\\n\\r\\nThe authentication information fields provide detailed information about this specific logon request.\\r\\n\\t- Transited services indicate which intermediate services have participated in this logon request.\\r\\n\\t- Package name indicates which sub-protocol was used among the NTLM protocols.\\r\\n\\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\",\"StringInserts\":[\"S-1-0-0\",\"-\",\"-\",\"0x0\",\"S-1-0-0\",\"Feadmin\",\"-\",\"0xc000006d\",\"%%2313\",\"0xc0000064\",3,\"NtLmSsp \",\"NTLM\",\"HAWKING\",\"-\",\"-\",0,\"0x0\",\"-\",\"193.3.19.205\",\"0\"]}\n{\"EventTime\":\"2021-10-02T18:58:55.322103+05:45\",\"Hostname\":\"IT02.corp.local\",\"Keywords\":\"9232379236109516800\",\"EventType\":\"AUDIT_SUCCESS\",\"SeverityValue\":2,\"Severity\":\"INFO\",\"EventID\":4688,\"SourceName\":\"Microsoft-Windows-Security-Auditing\",\"ProviderGuid\":\"{54849625-5478-4994-A5BA-3E3B0328C30D}\",\"Version\":2,\"TaskValue\":13312,\"OpcodeValue\":0,\"RecordNumber\":18995508,\"ExecutionProcessID\":4,\"ExecutionThreadID\":7816,\"Channel\":\"Security\",\"Message\":\"A new process has been created.\\r\\n\\r\\nCreator Subject:\\r\\n\\tSecurity ID:\\t\\tS-1-5-18\\r\\n\\tAccount Name:\\t\\tIT02$\\r\\n\\tAccount Domain:\\t\\tCORP\\r\\n\\tLogon ID:\\t\\t0x3E7\\r\\n\\r\\nTarget Subject:\\r\\n\\tSecurity ID:\\t\\tS-1-5-19\\r\\n\\tAccount Name:\\t\\tLOCAL SERVICE\\r\\n\\tAccount Domain:\\t\\tNT AUTHORITY\\r\\n\\tLogon ID:\\t\\t0x3E5\\r\\n\\r\\nProcess Information:\\r\\n\\tNew Process ID:\\t\\t0x134c\\r\\n\\tNew Process Name:\\tC:\\\\Windows\\\\System32\\\\svchost.exe\\r\\n\\tToken Elevation Type:\\t%%1936\\r\\n\\tMandatory Label:\\t\\tS-1-16-16384\\r\\n\\tCreator Process ID:\\t0x2c0\\r\\n\\tCreator Process Name:\\tC:\\\\Windows\\\\System32\\\\services.exe\\r\\n\\tProcess Command Line:\\tC:\\\\Windows\\\\system32\\\\svchost.exe -k LocalServiceNetworkRestricted -p -s WinHttpAutoProxySvc\\r\\n\\r\\nToken Elevation Type indicates the type of token that was assigned to the new process in accordance with User Account Control policy.\\r\\n\\r\\nType 1 is a full token with no privileges removed or groups disabled.  A full token is only used if User Account Control is disabled or if the user is the built-in Administrator account or a service account.\\r\\n\\r\\nType 2 is an elevated token with no privileges removed or groups disabled.  An elevated token is used when User Account Control is enabled and the user chooses to start the program using Run as administrator.  An elevated token is also used when an application is configured to always require administrative privilege or to always require maximum privilege, and the user is a member of the Administrators group.\\r\\n\\r\\nType 3 is a limited token with administrative privileges removed and administrative groups disabled.  The limited token is used when User Account Control is enabled, the application does not require administrative privilege, and the user does not choose to start the program using Run as administrator.\",\"Category\":\"Process Creation\",\"Opcode\":\"Info\",\"SubjectUserSid\":\"S-1-5-18\",\"SubjectUserName\":\"IT02$\",\"SubjectDomainName\":\"CORP\",\"SubjectLogonId\":\"0x3e7\",\"NewProcessId\":\"0x134c\",\"NewProcessName\":\"C:\\\\Windows\\\\System32\\\\svchost.exe\",\"TokenElevationType\":\"%%1936\",\"ProcessId\":\"0x2c0\",\"CommandLine\":\"C:\\\\Windows\\\\system32\\\\svchost.exe -k LocalServiceNetworkRestricted -p -s WinHttpAutoProxySvc\",\"TargetUserSid\":\"S-1-5-19\",\"TargetUserName\":\"LOCAL SERVICE\",\"TargetDomainName\":\"NT AUTHORITY\",\"TargetLogonId\":\"0x3e5\",\"ParentProcessName\":\"C:\\\\Windows\\\\System32\\\\services.exe\",\"MandatoryLabel\":\"S-1-16-16384\",\"EventReceivedTime\":\"2021-10-02T18:58:57.313105+05:45\",\"SourceModuleName\":\"in_win\",\"SourceModuleType\":\"im_msvistalog\"}","isRawInput":false,"pipelineVersion":"24.9.1"}